<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ESP32 Web Flasher</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    select, button { margin: 0.5rem; padding: 0.5rem; font-size: 1rem; }
  </style>
  <script type="module">
    import { install } from "https://unpkg.com/esp-web-tools@9.3.0/dist/web/install-button.js";

    const repo = "lewfpv/esp32-web-flasher";
    const branch = "main";
    const basePath = "firmwares";

    async function fetchDirs(path) {
      const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
      console.log("Lek√©rdezem a mapp√°t:", url);
      const res = await fetch(url);
      if (!res.ok) {
        console.error("Hiba a lek√©rdez√©sn√©l:", res.status, res.statusText);
        return [];
      }
      return await res.json();
    }

    async function loadProjects() {
      console.log("üîÑ Bet√∂lt√∂m a projekteket...");
      const projects = await fetchDirs(basePath);
      console.log("üì¶ Projektek JSON:", projects);

      const projectSelect = document.getElementById("project");
      projectSelect.innerHTML = `<option value="">-- v√°lassz projektet --</option>`;

      projects.forEach(p => {
        console.log("üìÅ Tal√°lt mappa:", p.name, "t√≠pus:", p.type);
        if (p.type === "dir") {
          const opt = document.createElement("option");
          opt.value = p.name;
          opt.textContent = p.name;
          projectSelect.appendChild(opt);
        }
      });

      projectSelect.onchange = loadVersions;
    }

    async function loadVersions() {
      const project = document.getElementById("project").value;
      console.log("üîÑ Bet√∂lt√∂m a verzi√≥kat a projekthez:", project);

      const versionSelect = document.getElementById("version");
      versionSelect.innerHTML = `<option value="">-- v√°lassz verzi√≥t --</option>`;
      if (!project) {
        console.warn("‚ö†Ô∏è Nincs projekt kiv√°lasztva!");
        return;
      }

      const versions = await fetchDirs(`${basePath}/${project}`);
      console.log("üì¶ Verzi√≥k JSON:", versions);

      versions.forEach(v => {
        console.log("üìÅ Tal√°lt verzi√≥:", v.name, "t√≠pus:", v.type);
        if (v.type === "dir") {
          const opt = document.createElement("option");
          opt.value = v.name;
          opt.textContent = v.name;
          versionSelect.appendChild(opt);
        }
      });
    }

    async function installSelected() {
      const project = document.getElementById("project").value;
      const version = document.getElementById("version").value;
      if (!project || !version) {
        alert("‚ö†Ô∏è V√°lassz projektet √©s verzi√≥t!");
        return;
      }

      const manifestUrl =
        `https://raw.githubusercontent.com/${repo}/${branch}/${basePath}/${project}/${version}/manifest.json`;

      console.log("üöÄ Flash ind√≠t√°sa a k√∂vetkez≈ë manifesttel:", manifestUrl);
      try {
        await install({ manifest: manifestUrl });
      } catch (e) {
        console.error("‚ùå Hiba a flash-el√©s k√∂zben:", e);
        alert("Nem siker√ºlt a flash-el√©s. Ellen≈ërizd a konzolt!");
      }
    }

    window.addEventListener("DOMContentLoaded", loadProjects);
  </script>
</head>
<body>
  <h1>ESP32 Web Flasher</h1>
  <p>V√°lassz projektet √©s firmware verzi√≥t:</p>
  <select id="project"></select>
  <select id="version"></select>
  <button onclick="installSelected()">Flash!</button>
  <p><small>Nyisd meg a b√∂ng√©sz≈ë konzolt (F12), ha hib√°t keresel!</small></p>
</body>
</html>
