<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ESP32 Web Flasher</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    select, button { margin: 0.5rem; padding: 0.5rem; font-size: 1rem; }
  </style>
  <script type="module">
    import { flash } from "https://unpkg.com/esp-web-tools@9.3.0/dist/web/install-button.js";

    const repo = "lewfpv/esp32-web-flasher"; // a saját repód
    const branch = "main"; // ha mást használsz, írd át
    const basePath = "firmwares";

    async function fetchDirs(path) {
      const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Nem tudtam lekérdezni: " + path);
      return await res.json();
    }

    async function loadProjects() {
      const projects = await fetchDirs(basePath);
      const projectSelect = document.getElementById("project");
      projectSelect.innerHTML = `<option value="">-- válassz projektet --</option>`;
      projects.forEach(p => {
        if (p.type === "dir") {
          const opt = document.createElement("option");
          opt.value = p.name;
          opt.textContent = p.name;
          projectSelect.appendChild(opt);
        }
      });
      projectSelect.onchange = loadVersions;
    }

    async function loadVersions() {
      const project = document.getElementById("project").value;
      const versionSelect = document.getElementById("version");
      versionSelect.innerHTML = `<option value="">-- válassz verziót --</option>`;
      if (!project) return;
      const versions = await fetchDirs(`${basePath}/${project}`);
      versions.forEach(v => {
        if (v.type === "dir") {
          const opt = document.createElement("option");
          opt.value = v.name;
          opt.textContent = v.name;
          versionSelect.appendChild(opt);
        }
      });
    }

    async function installSelected() {
      const project = document.getElementById("project").value;
      const version = document.getElementById("version").value;
      if (!project || !version) return alert("Válassz projektet és verziót!");

      const manifestUrl =
        `https://raw.githubusercontent.com/${repo}/${branch}/${basePath}/${project}/${version}/manifest.json`;

      console.log("Manifest URL:", manifestUrl);
      await flash({ manifest: manifestUrl });
    }

    loadProjects();
  </script>
</head>
<body>
  <h1>ESP32 Web Flasher</h1>
  <p>Válassz projektet és firmware verziót:</p>
  <select id="project"></select>
  <select id="version"></select>
  <button onclick="installSelected()">Flash!</button>
</body>
</html>
