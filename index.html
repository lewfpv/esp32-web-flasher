<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ESP32 Web Flasher</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    select, button { margin: 0.5rem; padding: 0.5rem; font-size: 1rem; }
    esp-web-install-button { margin-top: 1rem; display: block; }
  </style>
  <script type="module">
    const repo = "lewfpv/esp32-web-flasher";
    const branch = "main";
    const basePath = "firmwares";

    async function fetchDirs(path) {
      const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
      const res = await fetch(url);
      if (!res.ok) return [];
      return await res.json();
    }

    async function loadProjects() {
      const projects = await fetchDirs(basePath);
      const projectSelect = document.getElementById("project");
      projectSelect.innerHTML = `<option value="">-- válassz projektet --</option>`;
      projects.forEach(p => {
        if (p.type === "dir") {
          const opt = document.createElement("option");
          opt.value = p.name;
          opt.textContent = p.name;
          projectSelect.appendChild(opt);
        }
      });
      projectSelect.onchange = loadVersions;
    }

    async function loadVersions() {
      const project = document.getElementById("project").value;
      const versionSelect = document.getElementById("version");
      versionSelect.innerHTML = `<option value="">-- válassz verziót --</option>`;
      if (!project) return;

      const versions = await fetchDirs(`${basePath}/${project}`);
      versions.forEach(v => {
        if (v.type === "dir") {
          const opt = document.createElement("option");
          opt.value = v.name;
          opt.textContent = v.name;
          versionSelect.appendChild(opt);
        }
      });
    }

    function showInstaller() {
      const project = document.getElementById("project").value;
      const version = document.getElementById("version").value;
      const container = document.getElementById("installer");
      container.innerHTML = "";

      if (!project || !version) return;

      const manifestUrl = `https://raw.githubusercontent.com/${repo}/${branch}/${basePath}/${project}/${version}/manifest.json`;
      const btn = document.createElement("esp-web-install-button");
      btn.setAttribute("manifest", manifestUrl);
      container.appendChild(btn);
    }

    window.addEventListener("DOMContentLoaded", loadProjects);
  </script>
</head>
<body>
  <h1>ESP32 Web Flasher</h1>
  <p>Válassz projektet és firmware verziót:</p>
  <select id="project"></select>
  <select id="version"></select>
  <button onclick="showInstaller()">Flash!</button>

  <!-- Ide kerül a telepítő gomb -->
  <div id="installer"></div>

  <!-- ESP Web Tools elem -->
  <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
</body>
</html>
